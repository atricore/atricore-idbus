<?xml version="1.0" encoding="utf-8"?>
<!--
  ~ Atricore Console
  ~
  ~ Copyright 2009-2010, Atricore Inc.
  ~
  ~ This is free software; you can redistribute it and/or modify it
  ~ under the terms of the GNU Lesser General Public License as
  ~ published by the Free Software Foundation; either version 2.1 of
  ~ the License, or (at your option) any later version.
  ~
  ~ This software is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  ~ Lesser General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public
  ~ License along with this software; if not, write to the Free
  ~ Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  ~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->

<WizardStep
        xmlns="com.atricore.idbus.console.components.wizard.*"
        xmlns:mx="library://ns.adobe.com/flex/mx"
        xmlns:fx="http://ns.adobe.com/mxml/2009"
        xmlns:s="library://ns.adobe.com/flex/spark"
        stepName="Basic Authentication"
        xmlns:utils="com.atricore.idbus.console.components.*"
        creationComplete="initForm()">

        <fx:Script>
        <![CDATA[           

            import com.atricore.idbus.console.services.dto.DbIdentitySource;
            import com.atricore.idbus.console.services.dto.EmbeddedIdentitySource;
            import com.atricore.idbus.console.services.dto.IdentitySource;
            import com.atricore.idbus.console.services.dto.LdapIdentitySource;
            import com.atricore.idbus.console.services.dto.XmlIdentitySource;

            [Bindable]
            private var validators:Array;

            /**
             * This will holds the results
             */
            private var readableDecisionArray:Array;

            override public function get stepDecision():* {
                var identitySource:IdentitySource;
                readableDecisionArray = new Array();
                if (obfuscatePass.selected) {
                    //TODO
                    //                  identitySource.obfuscatePassword = obfuscatePass.selected;
                    readableDecisionArray.push("Obfuscate Password: " + obfuscatePass.selected);
                }

                if (embedded.selected) {
                    identitySource = new EmbeddedIdentitySource();
                    readableDecisionArray.push("Create Embedded Repository");
                } else {
                    readableDecisionArray.push("Create External Repository");
                    if (externalRepositoryType.selectedItem.data == "database") {
                        identitySource = new DbIdentitySource();
                    } else if (externalRepositoryType.selectedItem.data == "ldap") {
                        identitySource = new LdapIdentitySource();
                    } else if (externalRepositoryType.selectedItem.data == "xml") {
                        identitySource = new XmlIdentitySource();
                    }
                }
                
                identitySource.name = userRepositoryName.text;
                readableDecisionArray.push("Repository Name: " + identitySource.name);
                if (!(identitySource is EmbeddedIdentitySource)) {
                    readableDecisionArray.push("Repository type: " + externalRepositoryType.labelDisplay.text);
                }
                
                return identitySource;
            }

            override public function get readableStepDecision():String {
                return readableDecisionArray.join("\n").toString();
            }

            private function initForm():void {
                if (validators == null) {
                    validators = new Array();
                    validators.push(nameValidator);
                }
            }

            private function handleFormChange(event:Event):void {
                // Check the step validity
                ssoWizStep1Form.validateForm(event);
                isValid = ssoWizStep1Form.isValid;

                if (external.selected) {
                    if (!externalRepositoryType.enabled) {
                        externalRepositoryType.enabled = true;
                    }
                    if (externalRepositoryType.selectedItem.data == "database") {
                        jumpToStep = "databaseStep";
                    } else if (externalRepositoryType.selectedItem.data == "ldap") {
                        jumpToStep = "ldapStep";
                    } else if (externalRepositoryType.selectedItem.data == "xml") {
                        jumpToStep = "xmlStep";
                    }
                } else {
                    externalRepositoryType.enabled = false;
                    jumpToStep = "spStep";
                }
            }

            override public function get isJumpToConditionMet():Boolean {
                /*if (embedded.selected) {
                    return true;
                }
                return false;*/
                return true;
            }

        ]]>
    </fx:Script>
    <fx:Declarations>
        <utils:NameValidator id="nameValidator" source="{userRepositoryName}" required="true" property="text"/>
        <s:RadioButtonGroup id="repositoryType" itemClick="handleFormChange(event);"/>
    </fx:Declarations>

    <s:VGroup width="100%" height="100%">

        <utils:ValidatingForm id="ssoWizStep1Form" width="100%" height="100%" validators="{validators}" labelWidth="50"
                paddingLeft="10" paddingTop="10" paddingRight="10" paddingBottom="10">

            <utils:TitledBorderBox title="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.basicAuth')}"
                           width="100%" height="100%" cornerRadius="5" paddingLeft="10" paddingRight="5" paddingTop="20" paddingBottom="5">
                <s:CheckBox id="obfuscatePass" label="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.obfuscatePass')}" selected="true"/>
                <!--paddingLeft="65" paddingTop="40"-->
            </utils:TitledBorderBox>
            <utils:TitledBorderBox title="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.usersRepository')}"
                           width="100%" height="100%" cornerRadius="5" paddingLeft="10" paddingRight="5" paddingTop="20" paddingBottom="5">
                <mx:FormItem label="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.userRepositoryName')}:" required="true">
                    <s:TextInput id="userRepositoryName" width="300" change="handleFormChange(event);"/>
                </mx:FormItem>
                <mx:FormItem label="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.type')}:">
                    <s:RadioButton groupName="repositoryType" id="embedded" value="embedded" selected="true"
                            label="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.embeddedRepository')}"/>
                    <s:HGroup>
                        <s:RadioButton groupName="repositoryType" id="external" value="external"
                                label="{resourceManager.getString(AtricoreConsole.BUNDLE, 'ssoWiz.step1.externalRepository')}"/>
                        <s:DropDownList id="externalRepositoryType" width="100" selectedIndex="0" enabled="false" change="handleFormChange(event);">
                            <mx:ArrayCollection>
                                <fx:Object label="Database" data="database"/>
                                <fx:Object label="LDAP" data="ldap"/>
                                <fx:Object label="XML" data="xml"/>
                            </mx:ArrayCollection>
                        </s:DropDownList>
                    </s:HGroup>
                </mx:FormItem>
            </utils:TitledBorderBox>
       </utils:ValidatingForm>

    </s:VGroup>
</WizardStep>