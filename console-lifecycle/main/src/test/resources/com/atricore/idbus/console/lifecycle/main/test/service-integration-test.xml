<?xml version="1.0" encoding="ISO-8859-1" ?>
<!--
	~ Atricore IDBus
	~
	~ Copyright 2009, Atricore Inc.
	~
	~ This is free software; you can redistribute it and/or modify it
	~ under the terms of the GNU Lesser General Public License as
	~ published by the Free Software Foundation; either version 2.1 of
	~ the License, or (at your option) any later version.
	~
	~ This software is distributed in the hope that it will be useful,
	~ but WITHOUT ANY WARRANTY; without even the implied warranty of
	~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
	~ Lesser General Public License for more details.
	~
	~ You should have received a copy of the GNU Lesser General Public
	~ License along with this software; if not, write to the Free
	~ Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
	~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->
<s:beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:s="http://www.springframework.org/schema/beans"
         xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"
        >

  <!-- PMF Bean -->
    <bean id="pmf"
        class="org.springframework.orm.jdo.LocalPersistenceManagerFactoryBean">
        <property name="jdoProperties">
            <props>
                <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>
                <prop key="javax.jdo.option.ConnectionURL">jdbc:hsqldb:mem:nucleus1</prop>
                <prop key="javax.jdo.option.ConnectionUserName">sa</prop>
                <prop key="javax.jdo.option.ConnectionPassword"></prop>
                <prop key="javax.jdo.option.ConnectionDriverName">org.hsqldb.jdbcDriver</prop>
                
                <prop key="datanucleus.metadata.validate">false</prop>
				<prop key="datanucleus.autoCreateSchema">true</prop>
				<prop key="datanucleus.validateTables">false</prop>
				<prop key="datanucleus.validateConstraints">false</prop>
            </props>
        </property>
    </bean>

    <!-- Transaction Manager for PMF -->
    <bean id="jdoTransactionManager" class="org.springframework.orm.jdo.JdoTransactionManager">
        <property name="persistenceManagerFactory">
            <ref local="idbusProvisioningPmf"/>
        </property>
    </bean>    
	
	<bean id="smm" class="com.atricore.idbus.console.lifecycle.support.springmetadata.impl.SpringMetadataManagerImpl">
	    <property name="pmf">
            <ref local="idbusProvisioningPmf"/>
        </property>
	</bean>

    <bean id="beanUtils" class="com.atricore.idbus.console.lifecycle.support.springmetadata.util.BeanUtils">
    </bean>
	
    <bean id="identityBusMetadataManager" class="com.atricore.idbus.console.lifecycle.main.impl.IdentityBusMetadataManagerImpl">
        <property name="pmf">
            <ref local="idbusProvisioningPmf"/>
        </property>
        <!--<property name="smm">-->
        	<!--<ref local="smm"/>-->
        <!--</property>-->
		<!--<property name="beanService">-->
        	<!--<ref local="beanUtils"/>-->
        <!--</property>-->
		<property name="samlr2CapabilityMgr">
        	<ref local="samlr2CapabilityMetadataManager"/>
        </property>   
    </bean>

    <bean id="samlr2CapabilityMetadataManager" class="com.atricore.idbus.console.lifecycle.main.impl.SAMLR2CapabilityMetadataManagerImpl">
        <property name="pmf">
            <ref local="idbusProvisioningPmf"/>
        </property>
        <!--property name="smm">
        	<ref local="smm"/>
        </property>
		<property name="beanService">
        	<ref local="beanService"/>
        </property-->
		<property name="keystoreResolver">
        	<ref local="keystoreResolver"/>
        </property>
        <property name="bundleDescriptor">
        	<ref local="idauBundleDescriptor"/>
        </property>
    </bean>

	<bean id="keystoreResolver" class="com.atricore.idbus.console.lifecycle.main.util.SamlR2KeystoreKeyResolver">
		<property name="keystoreType" value="${keystore.keystoreType}"/>
		<property name="keystoreFile" value="file:${server.bundleInputFolder}${server.idauFolder}${keystore.fileName}"/>
		<property name="privateKeyAlias" value="${keystore.privateKeyAlias}"/>
		<property name="privateKeyPass" value="${keystore.privateKeyPass}"/>
		<property name="certificateAlias" value="${keystore.certificateAliasPrefix}"/>
		<property name="keystorePass" value="${keystore.keystorePass}"/>
	</bean>
	
	<bean id="idauBundleDescriptor" class="com.atricore.idbus.console.lifecycle.main.util.ApplianceUnitBundleDescriptor">
		<property name="fileName" value="${server.bundleFileName}"/>
		<property name="inputFolder" value="${server.bundleInputFolder}"/>
		<property name="outputFolder" value="${server.bundleOutputFolder}"/>
		<property name="idauFolder" value="${server.idauFolder}"/>
	</bean>
	
	<!--bean id="idApplianceManagementService" class="com.atricore.idbus.console.lifecycle.main.impl.IdentityApplianceManagementServiceImpl">
        <property name="bundleDescriptor">
        	<ref local="idauBundleDescriptor"/>
        </property>	
        <property name="smm">
        	<ref local="smm"/>
        </property>        
	</bean-->
	
	<bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>/com/atricore/idbus/console/lifecycle/main/test/server-bundle.properties</value>
			</list>
		</property>
	</bean>

<bean id="idbusProvisioningPmf"
        class="org.atricore.idbus.bundles.datanucleus.core.OsgiJDOPersistenceManagerFactoryBean"
        depends-on="osgiIdbusServerWebDbServerDescriptor">

        <property name="jdoProperties">

            <props>
                <prop key="javax.jdo.option.Mapping">hsql</prop>
                <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>

                <!-- Connection Information -->
                <!--
                <prop key="javax.jdo.option.ConnectionURL">jdbc:derby:idbus-provisioning;create=true</prop>
                <prop key="javax.jdo.option.ConnectionUserName">sa</prop>
                <prop key="javax.jdo.option.ConnectionPassword"></prop>
                -->
                <prop key="javax.jdo.option.ConnectionURL">jdbc:derby://localhost:1527/console;create=true</prop>
                <prop key="javax.jdo.option.ConnectionUserName">admin</prop>
                <prop key="javax.jdo.option.ConnectionPassword">admin</prop>
                <prop key="javax.jdo.option.ConnectionDriverName">org.apache.derby.jdbc.ClientDriver</prop>

                <prop key="datanucleus.storeManagerType">rdbms</prop>

                <prop key="datanucleus.metadata.validate">false</prop>
                <prop key="datanucleus.autoCreateSchema">true</prop>
                <prop key="datanucleus.autoCreateColumns">true</prop>
                <prop key="datanucleus.validateTables">false</prop>
                <prop key="datanucleus.validateConstraints">false</prop>

                <prop key="datanucleus.classLoaderResolverName">jdo</prop>

                <prop key="datanucleus.plugin.pluginRegistryClassName">org.atricore.idbus.bundles.datanucleus.core.OsgiPluginRegistry</prop>

            </props>
        </property>

    </bean>    

</s:beans>        