package com.atricore.idbus.console.lifecycle.main.transform.transformers;

import com.atricore.idbus.console.brandservice.main.domain.BrandingDefinition;
import com.atricore.idbus.console.brandservice.main.BrandingServiceException;
import com.atricore.idbus.console.brandservice.main.domain.CustomBrandingDefinition;
import com.atricore.idbus.console.brandservice.main.spi.BrandManager;
import com.atricore.idbus.console.lifecycle.main.domain.IdentityAppliance;
import com.atricore.idbus.console.lifecycle.main.domain.metadata.IdentityApplianceDefinition;
import com.atricore.idbus.console.lifecycle.main.domain.metadata.IdentityProvider;
import com.atricore.idbus.console.lifecycle.main.domain.metadata.Location;
import com.atricore.idbus.console.lifecycle.main.domain.metadata.Provider;
import com.atricore.idbus.console.lifecycle.main.transform.*;
import com.atricore.idbus.console.lifecycle.support.springmetadata.model.*;
import com.atricore.idbus.console.lifecycle.support.springmetadata.model.osgi.Service;
import com.atricore.idbus.console.lifecycle.support.springmetadata.model.pax.wicket.Application;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.Date;
import java.util.HashMap;

import static com.atricore.idbus.console.lifecycle.support.springmetadata.util.BeanUtils.*;
import static com.atricore.idbus.console.lifecycle.support.springmetadata.util.BeanUtils.setPropertyValue;

/**
 * @author <a href=mailto:sgonzalez@atricore.org>Sebastian Gonzalez Oyuela</a>
 */

public class IdauUITransformer extends AbstractTransformer {

    private BrandManager brandManager;

    private static Log logger = LogFactory.getLog(IdauBaseComponentsTransformer.class);

    @Override
    public boolean accept(TransformEvent event) {
        return event.getData() instanceof IdentityApplianceDefinition;
    }

    @Override
    public void before(TransformEvent event) {

        IdentityApplianceDefinition ida = (IdentityApplianceDefinition) event.getData();
        IdentityAppliance appliance = event.getContext().getProject().getIdAppliance();
        IdApplianceTransformationContext context = event.getContext();
        IdProjectModule module = context.getCurrentModule();

        Date now = new Date();

        // ----------------------------------------

        // ----------------------------------------

        // ----------------------------------------
        // UI Beans
        // ----------------------------------------

        Beans idauBeansUi = newBeans(ida.getName() + " UI : IdAU Configuration generated by Atricore Console on " + now.toGMTString());
        String uiBasePath = "IDBUS-UI";
        Location uiLocation = ida.getUiLocation();
        if (uiLocation != null) {
            uiBasePath = resolveLocationPath(uiLocation);
        }

        /* TODO : There are JDO issues to resolve !!!
        BrandingDefinition branding = null;
        if (ida.getUserDashboardBranding() != null) {

            try {
                branding = brandManager.lookupByName(ida.getUserDashboardBranding().getId());
            } catch (BrandingServiceException e) {
                throw new RuntimeException(e);
            }
        }
        */

        // ----------------------------------------
        // SSO Capability application(s)
        // ----------------------------------------
        {

            String path = module.getPath();
            String pkg = module.getPackage();
            String clazz = "SSOUIApplication";
            String parentClazz = "org.atricore.idbus.capabilities.sso.ui.internal.SSOUIApplication";

            IdProjectSource s = new IdProjectSource(clazz, path, clazz, "java", "extends");
            s.setExtension("java");
            s.setClassifier("velocity");

            java.util.Map<String, Object> params = new HashMap<String, Object>();
            params.put("package", pkg);
            params.put("clazz", clazz);
            params.put("parentClazz", parentClazz);
            s.setParams(params);
            module.addSource(s);

            Application ssoUiApp = new Application();
            ssoUiApp.setId(normalizeBeanName(ida.getName() + "-sso-ui"));
            ssoUiApp.setApplicationName(ida.getName().toLowerCase() + "-sso-ui");
            ssoUiApp.setClazz(pkg + "." + clazz);
            ssoUiApp.setMountPoint(uiBasePath + "/" + ida.getName().toUpperCase() + "/SSO");
            ssoUiApp.setInjectionSource("spring");

            idauBeansUi.getImportsAndAliasAndBeen().add(ssoUiApp);

            // App Configuration
            Bean appCfgBean = newBean(idauBeansUi, ssoUiApp.getId() + "-cfg", "org.atricore.idbus.capabilities.sso.ui.WebAppConfig");
            setPropertyValue(appCfgBean, "appName", ssoUiApp.getId());
            setPropertyValue(appCfgBean, "mountPoint", ssoUiApp.getMountPoint());
            if (ida.getUserDashboardBranding() != null) {
                setPropertyValue(appCfgBean, "brandingId", ida.getUserDashboardBranding().getId());
                /* TODO : There are JDO issues to resolve !!!
                if (branding != null) {
                    if (branding instanceof CustomBrandingDefinition) {
                        CustomBrandingDefinition cb = (CustomBrandingDefinition) branding;
                        if (cb.getCustomSsoAppClazz() != null) {
                            ssoUiApp.setClazz(cb.getCustomSsoAppClazz());
                        }
                    }

                } */
            }

            // Export App Configuration
            Service appCfgBeanOsgi = new Service();
            appCfgBeanOsgi.setId(appCfgBean.getName() + "-osgi");
            appCfgBeanOsgi.setRef(appCfgBean.getName());
            appCfgBeanOsgi.setInterface("org.atricore.idbus.capabilities.sso.ui.WebAppConfig");

            idauBeansUi.getImportsAndAliasAndBeen().add(appCfgBeanOsgi);

            // Now, do we need special apps for an IDP ?
            for (Provider p : ida.getProviders()) {
                if (p instanceof IdentityProvider) {
                    IdentityProvider idp = (IdentityProvider) p;
                    String idpBrandingId = idp.getUserDashboardBranding();

                    // If the IdP uses a different branding, create an application for it
                    if (idpBrandingId != null && !idpBrandingId.equals(ida.getUserDashboardBranding().getId())) {

                        Application idpUiApp = new Application();
                        idpUiApp.setId(normalizeBeanName(ida.getName() + "-" + idp.getName() + "-sso-ui"));
                        idpUiApp.setApplicationName(ida.getName().toLowerCase() + "-" + idp.getName().toLowerCase() + "-sso-ui");
                        idpUiApp.setClazz(pkg + "." + clazz);
                        idpUiApp.setMountPoint(uiBasePath + "/" + ida.getName().toUpperCase() + "/" + idp.getName().toUpperCase() + "/SSO");
                        idpUiApp.setInjectionSource("spring");

                        idauBeansUi.getImportsAndAliasAndBeen().add(idpUiApp);

                        // App Configuration
                        Bean idpAppCfgBean = newBean(idauBeansUi, idpUiApp.getId() + "-cfg", "org.atricore.idbus.capabilities.sso.ui.WebAppConfig");
                        setPropertyValue(idpAppCfgBean, "appName", idpUiApp.getId());
                        setPropertyValue(idpAppCfgBean, "mountPoint", idpUiApp.getMountPoint());
                        setPropertyValue(idpAppCfgBean, "brandingId", idpBrandingId);

                        // Export App Configuration
                        Service idpAppCfgBeanOsgi = new Service();
                        idpAppCfgBeanOsgi.setId(idpAppCfgBean.getName() + "-osgi");
                        idpAppCfgBeanOsgi.setRef(idpAppCfgBean.getName());
                        idpAppCfgBeanOsgi.setInterface("org.atricore.idbus.capabilities.sso.ui.WebAppConfig");

                        idauBeansUi.getImportsAndAliasAndBeen().add(idpAppCfgBeanOsgi);

                    }
                }
            }

        }

        // ----------------------------------------
        // OpenID Capability application
        // ----------------------------------------
        {

            String path = module.getPath();
            String pkg = module.getPackage();
            String clazz = "OpenIDUIApplication";
            String parentClazz = "org.atricore.idbus.capabilities.openid.ui.internal.OpenIDUIApplication";

            IdProjectSource s = new IdProjectSource(clazz, path, clazz, "java", "extends");
            s.setExtension("java");
            s.setClassifier("velocity");

            java.util.Map<String, Object> params = new HashMap<String, Object>();
            params.put("package", pkg);
            params.put("clazz", clazz);
            params.put("parentClazz", parentClazz);
            s.setParams(params);
            module.addSource(s);

            Application openIdUiApp = new Application();
            openIdUiApp.setId(ida.getName().toLowerCase() + "-openid-ui");
            openIdUiApp.setApplicationName(ida.getName().toLowerCase() + "-openid-ui");
            openIdUiApp.setClazz(pkg + "." + clazz);
            openIdUiApp.setMountPoint(uiBasePath + "/" + ida.getName().toUpperCase() + "/OPENID");
            openIdUiApp.setInjectionSource("spring");

            idauBeansUi.getImportsAndAliasAndBeen().add(openIdUiApp);

            // App Configuration
            Bean appCfgBean = newBean(idauBeansUi, openIdUiApp.getId() + "-cfg", "org.atricore.idbus.capabilities.sso.ui.WebAppConfig");
            setPropertyValue(appCfgBean, "appName", openIdUiApp.getId());
            setPropertyValue(appCfgBean, "mountPoint", openIdUiApp.getMountPoint());
            if (ida.getUserDashboardBranding() != null) {
                setPropertyValue(appCfgBean, "brandingId", ida.getUserDashboardBranding().getId());
                /* TODO : There are JDO issues to resolve !!!
                if (branding != null) {

                    if (branding instanceof CustomBrandingDefinition) {
                        CustomBrandingDefinition cb = (CustomBrandingDefinition) branding;
                        if (cb.getCustomSsoAppClazz() != null) {
                            openIdUiApp.setClazz(cb.getCustomOpenIdAppClazz());
                        }
                    }
                }
                */

            }

            // Export App Configuration
            Service appCfgBeanOsgi = new Service();
            appCfgBeanOsgi.setId(appCfgBean.getName() + "-osgi");
            appCfgBeanOsgi.setRef(appCfgBean.getName());
            appCfgBeanOsgi.setInterface("org.atricore.idbus.capabilities.sso.ui.WebAppConfig");

            idauBeansUi.getImportsAndAliasAndBeen().add(appCfgBeanOsgi);



        }

        // ----------------------------------------
        // Add all the beans to the list
        // ----------------------------------------
        IdProjectResource<Beans> rBeansUi =  new IdProjectResource<Beans>(idGen.generateId(), "beans-ui", "spring-beans", idauBeansUi);
        rBeansUi.setClassifier("jaxb");
        module.addResource(rBeansUi);

    }

    public BrandManager getBrandManager() {
        return brandManager;
    }

    public void setBrandManager(BrandManager brandManager) {
        this.brandManager = brandManager;
    }
}