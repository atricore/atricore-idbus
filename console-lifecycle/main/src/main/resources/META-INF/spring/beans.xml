<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:osgi="http://www.springframework.org/schema/osgi"
xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
xmlns:ctx="http://www.springframework.org/schema/context"
xsi:schemaLocation="http://www.springframework.org/schema/beans
                    http://www.springframework.org/schema/beans/spring-beans.xsd
                    http://www.springframework.org/schema/osgi
                    http://www.springframework.org/schema/osgi/spring-osgi.xsd
                    http://www.springframework.org/schema/context
                    http://www.springframework.org/schema/context/spring-context.xsd
                    http://www.springframework.org/schema/osgi-compendium
                    http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd
                    ">

    <!-- ===================================================================== -->
    <!-- User Provissioning componentes                                        -->
    <!-- ===================================================================== -->

    <bean id="idbusLifecyclePmf"
        class="org.atricore.idbus.bundles.datanucleus.core.OsgiJDOPersistenceManagerFactoryBean">
        <property name="jdoProperties" ref="lifecycleJDOProps"/>
    </bean>

    <bean name="passwordHashUtil"
          class="com.atricore.idbus.console.lifecycle.main.util.PasswordHashUtil">
            <property name="hashAlgorithm" value="MD5"/>
            <property name="hashEncoding" value="HEX"/>
    </bean>

    <bean id="transactionManager" class="org.springframework.orm.jdo.JdoTransactionManager">
        <property name="persistenceManagerFactory">
            <ref local="idbusLifecyclePmf"/>
        </property>
    </bean>

    <bean id="sessionTokenGeneratorBean" class="com.atricore.idbus.console.lifecycle.main.impl.SessionTokenGeneratorImpl">
        <property name="algorithm" value="MD5" />
    </bean>

    <!-- ===================================================================== -->
    <!-- Metadata Management components                                        -->
    <!-- ===================================================================== -->

    <bean id="smm" class="com.atricore.idbus.console.lifecycle.support.springmetadata.impl.SpringMetadataManagerImpl">
        <property name="pmf" ref="idbusLifecyclePmf"/>
    </bean>

    <bean id="beanUtils" class="com.atricore.idbus.console.lifecycle.support.springmetadata.util.BeanUtils"/>

	<bean id="keystoreResolver" class="com.atricore.idbus.console.lifecycle.main.util.SamlR2KeystoreKeyResolver">
		<property name="keystoreType" value="${keystore.keystoreType}"/>
		<property name="keystoreFile" value="file:${server.bundleInputFolder}${server.idauFolder}${keystore.fileName}"/>
		<property name="privateKeyAlias" value="${keystore.privateKeyAlias}"/>
		<property name="privateKeyPass" value="${keystore.privateKeyPass}"/>
		<property name="certificateAlias" value="${keystore.certificateAliasPrefix}"/>
		<property name="keystorePass" value="${keystore.keystorePass}"/>
	</bean>

    <bean id="idauBundleDescriptor" class="com.atricore.idbus.console.lifecycle.main.util.ApplianceUnitBundleDescriptor">
		<property name="fileName" value="${server.bundleFileName}"/>
		<property name="inputFolder" value="${server.bundleInputFolder}"/>
		<property name="outputFolder" value="${server.bundleOutputFolder}"/>
		<property name="idauFolder" value="${server.idauFolder}"/>
	</bean>

	<bean id="idApplianceManagementService"
          class="com.atricore.idbus.console.lifecycle.main.impl.IdentityApplianceManagementServiceImpl">

        <property name="lazySyncAppliances" value="true"/>

        <property name="activationService" ref="activationService" />
        <property name="builder" ref="applianceBuilder"/>
        <property name="deployer" ref="applianceDeployer"/>
        <!-- DAO's -->
        <property name="identityApplianceDAO" ref="identityApplianceDAO"/>
        <property name="identityApplianceDefinitionDAO" ref="identityApplianceDefinitionDAO"/>
        <property name="identitySourceDAO" ref="identitySourceDAO"/>
        <property name="userInformationLookupDAO" ref="userInformationLookupDAO"/>
        <property name="accountLinkagePolicyDAO" ref="accountLinkagePolicyDAO"/>
        <property name="authenticationContractDAO" ref="authenticationContractDAO"/>
        <property name="authenticationMechanismDAO" ref="authenticationMechanismDAO"/>
        <property name="attributeProfileDAO" ref="attributeProfileDAO"/>
        <property name="authenticationAssertionEmissionPolicyDAO" ref="authenticationAssertionEmissionPolicyDAO"/>
        <property name="resourceDAO" ref="resourceDAO"/>

        <property name="validator" ref="applianceDefValidator"/>
    </bean>

    <bean id="applianceDefValidator" class="com.atricore.idbus.console.lifecycle.main.impl.ApplianceValidatorImpl" >
        <property name="walker" >
            <bean name="idbusWalker"
                  class="com.atricore.idbus.console.lifecycle.main.transform.ReflexiveIdentityApplianceDefinitionWalker"/>
        </property>
    </bean>

    <bean id="applianceDeployer" class="com.atricore.idbus.console.lifecycle.main.impl.FeaturesBasedApplianceDeployer">
        <!--property name="featuresService" ref="featuresService"/-->
    </bean>

    <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>server-bundle.properties</value>
            </list>
        </property>
    </bean>

    <!-- ===================================================================== -->
    <!-- IDBus Server Management Services exported as OSGI Services            -->
    <!-- ===================================================================== -->

    <osgi:service id="osgiIdApplianceManagementService"
                  ref="idApplianceManagementService"
            interface="com.atricore.idbus.console.lifecycle.main.spi.IdentityApplianceManagementService"/>

    <osgi:reference id="activationService" cardinality="1..1" timeout="60"
                    interface="com.atricore.idbus.console.activation.main.spi.ActivationService"  />

    <!-- =================================================================== -->
    <!-- Configuration Admin entry                                           -->
    <!-- =================================================================== -->

    <!-- Expose JDO Properties as OSGi configuration properties -->
    <osgix:cm-properties id="lifecycleJDOProps" persistent-id="com.atricore.idbus.console.lifecycle.jdo">

        <prop key="javax.jdo.option.Mapping">default</prop>
        <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>

        <prop key="javax.jdo.option.ConnectionURL">jdbc:derby://localhost:1527/idbus-console;create=true</prop>
        <prop key="javax.jdo.option.ConnectionUserName">atricore</prop>
        <prop key="javax.jdo.option.ConnectionPassword">admin</prop>
        <prop key="javax.jdo.option.ConnectionDriverName">org.apache.derby.jdbc.ClientDriver</prop>

        <prop key="datanucleus.storeManagerType">rdbms</prop>

        <prop key="datanucleus.metadata.validate">false</prop>
        <prop key="datanucleus.autoCreateSchema">true</prop>
        <prop key="datanucleus.autoCreateColumns">true</prop>
        <prop key="datanucleus.validateTables">false</prop>
        <prop key="datanucleus.validateConstraints">false</prop>

        <prop key="datanucleus.classLoaderResolverName">jdo</prop>

        <prop key="datanucleus.plugin.pluginRegistryClassName">org.atricore.idbus.bundles.datanucleus.core.OsgiPluginRegistry</prop>

    </osgix:cm-properties>

    <ctx:property-placeholder properties-ref="lifecycleJDOProps" />

    <osgix:cm-properties id="lifecycleProps" persistent-id="com.atricore.idbus.console.lifecycle">
    </osgix:cm-properties>

    <ctx:property-placeholder properties-ref="lifecycleProps" />




</beans>