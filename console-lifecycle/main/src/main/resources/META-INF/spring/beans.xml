<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:osgi="http://www.springframework.org/schema/osgi"
       xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
       xmlns:ctx="http://www.springframework.org/schema/context"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                    http://www.springframework.org/schema/beans/spring-beans.xsd
                    http://www.springframework.org/schema/osgi
                    http://www.springframework.org/schema/osgi/spring-osgi.xsd
                    http://www.springframework.org/schema/context
                    http://www.springframework.org/schema/context/spring-context.xsd
                    http://www.springframework.org/schema/osgi-compendium
                    http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

    <tx:annotation-driven/>

    <!-- ===================================================================== -->
    <!-- User Provissioning componentes                                        -->
    <!-- ===================================================================== -->

    <bean name="passwordHashUtil"
          class="com.atricore.idbus.console.lifecycle.main.util.PasswordHashUtil">
        <property name="hashAlgorithm" value="MD5"/>
        <property name="hashEncoding" value="HEX"/>
    </bean>

    <bean id="sessionTokenGeneratorBean"
          class="com.atricore.idbus.console.lifecycle.main.impl.SessionTokenGeneratorImpl">
        <property name="algorithm" value="MD5"/>
    </bean>

    <!-- ===================================================================== -->
    <!-- Metadata Management components                                        -->
    <!-- ===================================================================== -->

    <bean id="smm" class="com.atricore.idbus.console.lifecycle.support.springmetadata.impl.SpringMetadataManagerImpl">
        <property name="pmf" ref="idbusLifecyclePmf"/>
    </bean>

    <bean id="beanUtils" class="com.atricore.idbus.console.lifecycle.support.springmetadata.util.BeanUtils"/>

    <!--
    <bean id="keystoreResolver" class="com.atricore.idbus.console.lifecycle.main.util.SamlR2KeystoreKeyResolver">
        <property name="keystoreType" value="${keystore.keystoreType}"/>
        <property name="keystoreFile" value="file:${server.bundleInputFolder}${server.idauFolder}${keystore.fileName}"/>
        <property name="privateKeyAlias" value="${keystore.privateKeyAlias}"/>
        <property name="privateKeyPass" value="${keystore.privateKeyPass}"/>
        <property name="certificateAlias" value="${keystore.certificateAliasPrefix}"/>
        <property name="keystorePass" value="${keystore.keystorePass}"/>
    </bean>

    <bean id="idauBundleDescriptor"
          class="com.atricore.idbus.console.lifecycle.main.util.ApplianceUnitBundleDescriptor">
        <property name="fileName" value="${server.bundleFileName}"/>
        <property name="inputFolder" value="${server.bundleInputFolder}"/>
        <property name="outputFolder" value="${server.bundleOutputFolder}"/>
        <property name="idauFolder" value="${server.idauFolder}"/>
    </bean>
    -->

    <bean id="idApplianceManagementService"
          class="com.atricore.idbus.console.lifecycle.main.impl.IdentityApplianceManagementServiceImpl">

        <property name="jdbcDriverManager" ref="jdbcDriverManager"/>

        <property name="lazySyncAppliances" value="true"/>

        <property name="validateAppliances" value="${lifecycle.validateAppliances}"/>
        <property name="enableDebugValidation" value="${lifecycle.enableDebugValidation}"/>

        <property name="validator" ref="applianceDefValidator"/>
        <property name="activationService" ref="activationService"/>
        <property name="activationClientFactory" ref="activationClientFactory"/>
        <property name="builder" ref="applianceBuilder"/>
        <property name="deployer" ref="applianceDeployer"/>
        <property name="marshaller" ref="applianceMarshaller"/>

        <property name="sampleKeystore" ref="sampleKeystore"/>

        <property name="identityMappingPoliciesRegistry" ref="identityMappingPoliciesRegistry"/>
        <property name="userDashboardBrandingRegistry" ref="userDashboardBrandingsRegistry"/>
        <property name="accountLinkagePoliciesRegistry" ref="accountLinkagePoliciesRegistry"/>
        <property name="subjectNameIdentifierPolicyRegistry" ref="subjectNameIdentifierPolicyRegistry"/>
        <property name="impersonateUserPoliciesRegistry" ref="impersonateUserPoliciesRegistry"/>

        <!-- DAO's -->
        <property name="identityApplianceDAO" ref="identityApplianceDAO"/>
        <property name="identityApplianceDefinitionDAO" ref="identityApplianceDefinitionDAO"/>
        <property name="identityApplianceDeploymentDAO" ref="identityApplianceDeploymentDAO"/>
        <property name="identityApplianceUnitDAO" ref="identityApplianceUnitDAO"/>
        <property name="identitySourceDAO" ref="identitySourceDAO"/>
        <property name="userInformationLookupDAO" ref="userInformationLookupDAO"/>
        <property name="federatedConnectionDAO" ref="federatedConnectionDAO"/>
        <property name="accountLinkagePolicyDAO" ref="accountLinkagePolicyDAO"/>
        <property name="authenticationContractDAO" ref="authenticationContractDAO"/>
        <property name="authenticationMechanismDAO" ref="authenticationMechanismDAO"/>
        <property name="attributeProfileDAO" ref="attributeProfileDAO"/>
        <property name="authenticationAssertionEmissionPolicyDAO" ref="authenticationAssertionEmissionPolicyDAO"/>
        <property name="resourceDAO" ref="resourceDAO"/>

    </bean>

    <bean id="applianceDefValidator" class="com.atricore.idbus.console.lifecycle.main.impl.ApplianceValidatorImpl">
        <property name="walker">
            <bean name="idbusWalker"
                  class="com.atricore.idbus.console.lifecycle.main.transform.ReflexiveIdentityApplianceDefinitionWalker"/>
        </property>
        <property name="dao" ref="identityApplianceDAO"/>
    </bean>

    <bean id="applianceDeployer" class="com.atricore.idbus.console.lifecycle.main.impl.FeaturesBasedApplianceDeployer">
        <!--property name="featuresService" ref="featuresService"/-->
    </bean>

    <bean id="applianceMarshaller" class="com.atricore.idbus.console.lifecycle.main.impl.ApplianceSpringMarshaller">
        <property name="walker" >
            <bean class="com.atricore.idbus.console.lifecycle.main.transform.ReflexiveIdentityApplianceDefinitionWalker"/>
        </property>
    </bean>

    <!--
    <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>server-bundle.properties</value>
            </list>
        </property>
    </bean>
    -->

    <!-- ===================================================================== -->
    <!-- Lifecycle  Management Services exported as OSGI Services              -->
    <!-- ===================================================================== -->

    <osgi:service id="osgiIdApplianceManagementService"
                  ref="idApplianceManagementService"
                  interface="com.atricore.idbus.console.lifecycle.main.spi.IdentityApplianceManagementService"/>

    <bean name="servicesLifecycelMgr" class="com.atricore.idbus.console.lifecycle.main.boot.ServicesLifecycleManager"/>

    <osgi:service id="osgiServicesLifecycelMgr" ref="servicesLifecycelMgr"
                  interface="org.springframework.osgi.context.event.OsgiBundleApplicationContextListener" />

    <!-- The default branding has no skin -->
    <bean name="josso2-default-branding" class="com.atricore.idbus.console.lifecycle.main.domain.metadata.UserDashboardBranding">
        <property name="id" value="josso2-default-branding"/>
        <property name="description" value="JOSSO 2 Default"/>
        <property name="name" value="josso2-default-branding"/>
    </bean>
    <osgi:service id="josso2-default-branding-osgi" ref="josso2-default-branding"
                  interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.UserDashboardBranding"/>

    <!-- Alternative branding
    <bean name="josso2-alt-branding" class="com.atricore.idbus.console.lifecycle.main.domain.metadata.UserDashboardBranding">
        <property name="id" value="josso2-alt-branding"/>
        <property name="description" value="JOSSO 2 Alternative"/>
        <property name="name" value="josso2-alt-branding"/>
        <property name="skin" value="alt_1"/>
    </bean>
    <osgi:service id="josso2-alt-branding-osgi" ref="josso2-alt-branding"
                  interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.UserDashboardBranding"/>
    -->


    <!-- ===================================================================== -->
    <!-- Lifecycle  Management Components imported  as OSGI Services           -->
    <!-- ===================================================================== -->

    <osgi:reference id="activationService" cardinality="1..1" timeout="60"
                    interface="com.atricore.idbus.console.activation.main.spi.ActivationService"/>

    <osgi:reference id="activationClientFactory" cardinality="1..1" timeout="60"
                    interface="com.atricore.idbus.console.activation.main.client.ActivationClientFactory"/>

    <osgi:reference id="jdbcDriverManager" timeout="60" cardinality="1..1"
                    interface="org.atricore.idbus.kernel.common.support.jdbc.JDBCDriverManager"/>

    <bean name="accountLinkagePoliciesRegistry"
          class="com.atricore.idbus.console.lifecycle.main.impl.AccountLinkagePoliciesRegistry">

    </bean>

    <bean name="subjectNameIdentifierPolicyRegistry"
          class="com.atricore.idbus.console.lifecycle.main.impl.SubjectNameIdentifierPolicyRegistry">

    </bean>

    <bean name="impersonateUserPoliciesRegistry"
          class="com.atricore.idbus.console.lifecycle.main.impl.ImpersonateUserPoliciesRegistry">

    </bean>

    <bean name="identityMappingPoliciesRegistry"
          class="com.atricore.idbus.console.lifecycle.main.impl.IdentityMappingPoliciesRegistry">

    </bean>

    <bean name="userDashboardBrandingsRegistry"
          class="com.atricore.idbus.console.lifecycle.main.impl.UserDashboardBrandingRegistry">

    </bean>

    <osgi:list id="customAccountLinkagePolicies" cardinality="0..N"
               interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.AccountLinkagePolicy">
        <osgi:listener ref="accountLinkagePoliciesRegistry"
                       bind-method="register"
                       unbind-method="unregister"/>
    </osgi:list>

    <osgi:list id="customIdentityMappingPolicies" cardinality="0..N"
               interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.IdentityMappingPolicy">
        <osgi:listener ref="identityMappingPoliciesRegistry"
                       bind-method="register"
                       unbind-method="unregister"/>
    </osgi:list>

    <osgi:list id="customSubjectNameIdentifierPolicies" cardinality="0..N"
               interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.SubjectNameIdentifierPolicy">
        <osgi:listener ref="subjectNameIdentifierPolicyRegistry"
                       bind-method="register"
                       unbind-method="unregister"/>
    </osgi:list>

    <osgi:list id="customImpersonateUserPolicies" cardinality="0..N"
               interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.ImpersonateUserPolicy">
        <osgi:listener ref="impersonateUserPoliciesRegistry"
                       bind-method="register"
                       unbind-method="unregister"/>
    </osgi:list>

    <osgi:list id="userDashboardBrandings" cardinality="0..N"
               interface="com.atricore.idbus.console.lifecycle.main.domain.metadata.UserDashboardBranding">
        <osgi:listener ref="userDashboardBrandingsRegistry"
                       bind-method="register"
                       unbind-method="unregister"/>

    </osgi:list>


    <!-- =================================================================== -->
    <!-- Configuration Admin entry                                           -->
    <!-- =================================================================== -->

    <!-- Use spring bean setup, to allow multiple config sources -->
    <!--ctx:property-placeholder properties-ref="lifecycleProps" /-->
    <bean id="myBundleConfigurer"
                class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="ignoreUnresolvablePlaceholders" value="true"/>
        <property name="propertiesArray">
            <list>
                <ref bean="lifecycleProps"/>
                <ref bean="lifecycleJdoProps"/>
            </list>
        </property>
    </bean>

    <!-- Expose JDO Properties as OSGi configuration properties -->
    <osgix:cm-properties id="lifecycleProps"
                         persistent-id="com.atricore.idbus.console.lifecycle"/>

    <osgix:cm-properties id="lifecycleJdoProps"
                         persistent-id="com.atricore.idbus.console.db">

        <prop key="javax.jdo.option.Mapping">default</prop>
        <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>

        <prop key="jdbc.dataSourceUrl">osgi:javax.sql.DataSource/(&amp;(jdbcDS=default-ds))</prop>
 <!--   We're using a datasource now :
        <prop key="javax.jdo.option.ConnectionURL">jdbc:derby://localhost:1527/atricore-console;create=true</prop>

        <prop key="javax.jdo.option.ConnectionUserName">atricore</prop>
        <prop key="javax.jdo.option.ConnectionPassword">admin</prop>
        <prop key="javax.jdo.option.ConnectionDriverName">org.apache.derby.jdbc.ClientDriver</prop>
-->

        <prop key="datanucleus.storeManagerType">rdbms</prop>

        <prop key="datanucleus.metadata.validate">false</prop>
        <prop key="datanucleus.autoCreateSchema">true</prop>
        <prop key="datanucleus.autoCreateColumns">true</prop>
        <prop key="datanucleus.validateTables">false</prop>
        <prop key="datanucleus.validateConstraints">false</prop>

        <prop key="datanucleus.classLoaderResolverName">jdo</prop>

        <prop key="datanucleus.plugin.pluginRegistryClassName">org.atricore.idbus.bundles.datanucleus.core.OsgiPluginRegistry</prop>

        <prop key="lifecycle.validateAppliances">true</prop>
        <prop key="lifecycle.enableDebugValidation">false</prop>

        <prop key="datanucleus.metadata.autoregistration">false</prop>

    </osgix:cm-properties>

</beans>
