<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:osgi="http://www.springframework.org/schema/osgi"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                    http://www.springframework.org/schema/beans/spring-beans.xsd
                    http://www.springframework.org/schema/osgi
                    http://www.springframework.org/schema/osgi/spring-osgi.xsd">

    <!-- ===================================================================== -->
    <!-- User Provissioning componentes                                        -->
    <!-- ===================================================================== -->

    <!-- ===================================================================== -->
    <!-- Define a DB Server for IDBus Server application                       -->
    <bean id="idbusServerWebDbServerDescriptor"
          class="org.atricore.idbus.bundles.apache.derby.NetworkServerDescriptor" >
        <property name="port" value="1527"/>
        <property name="username" value="admin"/>
        <property name="password" value="admin"/>
    </bean>
    <!-- Contribute the DB Server Descriptor using Spring DM -->
    <osgi:service id="osgiIdbusServerWebDbServerDescriptor"
                  ref="idbusServerWebDbServerDescriptor"
            interface="org.atricore.idbus.bundles.apache.derby.NetworkServerDescriptor"/>
    <!-- ===================================================================== -->

    <bean id="idbusProvisioningPmf"
        class="org.atricore.idbus.bundles.datanucleus.core.OsgiJDOPersistenceManagerFactoryBean"
        depends-on="osgiIdbusServerWebDbServerDescriptor">

        <property name="jdoProperties">

            <props>
                <prop key="javax.jdo.option.Mapping">default</prop>
                <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>

                <!-- Connection Information -->
                <!--
                <prop key="javax.jdo.option.ConnectionURL">jdbc:derby:idbus-provisioning;create=true</prop>
                <prop key="javax.jdo.option.ConnectionUserName">sa</prop>
                <prop key="javax.jdo.option.ConnectionPassword"></prop>
                -->
                <prop key="javax.jdo.option.ConnectionURL">jdbc:derby://localhost:1527/console;create=true</prop>
                <prop key="javax.jdo.option.ConnectionUserName">admin</prop>
                <prop key="javax.jdo.option.ConnectionPassword">admin</prop>
                <prop key="javax.jdo.option.ConnectionDriverName">org.apache.derby.jdbc.ClientDriver</prop>

                <prop key="datanucleus.storeManagerType">rdbms</prop>

                <prop key="datanucleus.metadata.validate">false</prop>
                <prop key="datanucleus.autoCreateSchema">true</prop>
                <prop key="datanucleus.autoCreateColumns">true</prop>
                <prop key="datanucleus.validateTables">false</prop>
                <prop key="datanucleus.validateConstraints">false</prop>

                <prop key="datanucleus.classLoaderResolverName">jdo</prop>

                <prop key="datanucleus.plugin.pluginRegistryClassName">org.atricore.idbus.bundles.datanucleus.core.OsgiPluginRegistry</prop>

            </props>
        </property>

    </bean>

    <bean name="passwordHashUtil"
          class="org.atricore.idbus.capabilities.management.main.util.PasswordHashUtil">
            <property name="hashAlgorithm" value="MD5"/>
            <property name="hashEncoding" value="HEX"/>
    </bean>

    <bean id="userProvisioningServiceManagerBean" class="org.atricore.idbus.capabilities.management.main.impl.UserProvisioningServiceJDOImpl">
        <property name="pmf" ref="idbusProvisioningPmf"/>
        <property name="passwordHashUtil" ref="passwordHashUtil"/>
    </bean>

    <bean id="profileManagementServiceBean" class="org.atricore.idbus.capabilities.management.main.impl.ProfileManagementServiceImpl">
        <property name="pmf" ref="idbusProvisioningPmf"/>
        <property name="passwordHashUtil" ref="passwordHashUtil"/>
    </bean>

    <bean id="idbusProvisioningTransactionManager" class="org.springframework.orm.jdo.JdoTransactionManager">
        <property name="persistenceManagerFactory">
            <ref local="idbusProvisioningPmf"/>
        </property>
    </bean>

    <bean id="signOnServiceBean" class="org.atricore.idbus.capabilities.management.main.impl.SignOnServiceImpl">
        <property name="sessionTokenGenerator" ref="sessionTokenGeneratorBean"/>
        <property name="userProvisioningService" ref="userProvisioningServiceManagerBean"/>
        <property name="passwordHashUtil" ref="passwordHashUtil"/>
    </bean>

    <bean id="sessionTokenGeneratorBean" class="org.atricore.idbus.capabilities.management.main.impl.SessionTokenGeneratorImpl">
        <property name="algorithm" value="MD5" />
    </bean>

    <!-- ===================================================================== -->
    <!-- Metadata Management components                                        -->
    <!-- ===================================================================== -->

    <bean id="smm" class="org.atricore.idbus.capabilities.management.support.springmetadata.impl.SpringMetadataManagerImpl">
        <property name="pmf" ref="idbusProvisioningPmf"/>
    </bean>

    <bean id="beanUtils" class="org.atricore.idbus.capabilities.management.support.springmetadata.util.BeanUtils"/>

	<bean id="keystoreResolver" class="org.atricore.idbus.capabilities.management.main.util.SamlR2KeystoreKeyResolver">
		<property name="keystoreType" value="${keystore.keystoreType}"/>
		<property name="keystoreFile" value="file:${server.bundleInputFolder}${server.idauFolder}${keystore.fileName}"/>
		<property name="privateKeyAlias" value="${keystore.privateKeyAlias}"/>
		<property name="privateKeyPass" value="${keystore.privateKeyPass}"/>
		<property name="certificateAlias" value="${keystore.certificateAliasPrefix}"/>
		<property name="keystorePass" value="${keystore.keystorePass}"/>
	</bean>

    <bean id="idauBundleDescriptor" class="org.atricore.idbus.capabilities.management.main.util.ApplianceUnitBundleDescriptor">
		<property name="fileName" value="${server.bundleFileName}"/>
		<property name="inputFolder" value="${server.bundleInputFolder}"/>
		<property name="outputFolder" value="${server.bundleOutputFolder}"/>
		<property name="idauFolder" value="${server.idauFolder}"/>
	</bean>

	<!--<bean id="idApplianceManagementService" class="org.atricore.idbus.capabilities.management.main.impl.IdentityApplianceManagementServiceMockImpl" />-->

    <!-- TODO : switch to production implementation -->
	<bean id="idApplianceManagementService" class="org.atricore.idbus.capabilities.management.main.impl.IdentityApplianceManagementServiceImpl">
        <property name="pmf">
            <ref local="idbusProvisioningPmf"/>
        </property>
        <property name="builder" ref="applianceBuilder"/>
        <property name="deployer" ref="applianceDeployer"/>
    </bean>

    <bean id="applianceDeployer" class="org.atricore.idbus.capabilities.management.main.impl.FeaturesBasedApplianceDeployer">
        <!--property name="featuresService" ref="featuresService"/-->
    </bean>

    <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>server-bundle.properties</value>
            </list>
        </property>
    </bean>

    <!-- ===================================================================== -->
    <!-- IDBus Server Management Services exported as OSGI Services            -->
    <!-- ===================================================================== -->


    <osgi:service id="osgiUserProvisioningServiceManagerBean"
                  ref="userProvisioningServiceManagerBean"
            interface="org.atricore.idbus.capabilities.management.main.spi.UserProvisioningService"/>

    <osgi:service id="osgiIdApplianceManagementService"
                  ref="idApplianceManagementService"
            interface="org.atricore.idbus.capabilities.management.main.spi.IdentityApplianceManagementService"/>

    <osgi:service id="osgiProfileManagementServiceBean"
                  ref="profileManagementServiceBean"
            interface="org.atricore.idbus.capabilities.management.main.spi.ProfileManagementService"/>

    <osgi:service id="osgiSignOnServiceBean"
                  ref="signOnServiceBean"
            interface="org.atricore.idbus.capabilities.management.main.spi.SignOnService"/>


    <!-- TODO : Make this work Provided by Karaf
    <osgi:reference id="featuresService" cardinality="1..1" timeout="60"
                    interface="org.apache.felix.karaf.features.FeaturesService"  />
    -->


</beans>