<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:osgi="http://www.springframework.org/schema/osgi"
       xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
       xmlns:ctx="http://www.springframework.org/schema/context"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                    http://www.springframework.org/schema/beans/spring-beans.xsd
                    http://www.springframework.org/schema/osgi
                    http://www.springframework.org/schema/osgi/spring-osgi.xsd
                    http://www.springframework.org/schema/context
                    http://www.springframework.org/schema/context/spring-context.xsd
                    http://www.springframework.org/schema/osgi-compendium
                    http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

    <tx:annotation-driven/>

    <bean id="brandManager" class="com.atricore.idbus.console.brandservice.main.internal.BrandManagerImpl" >
        <property name="store">
            <ref bean="brandingStore"/>
        </property>

        <property name="refreshPackagesDelay" value="${brandManager.refreshPackagesDelay}" />

        <property name="disableHotDeploy" value="${brandManager.disableHotDeploy}" />
        <property name="installers">
            <list>
                <ref bean="customBrandingInstaller"/>
            </list>
        </property>
        <!-- Brandings provided with JOSSO -->
        <property name="builtInBrandings">
            <list>
                <bean class="com.atricore.idbus.console.brandservice.main.domain.BuiltInBrandingDefinition">
                    <!-- Name is referenced somewhere else -->
                    <property name="name" value="josso2-default-branding"/>
                    <property name="description" value="JOSSO 2.X Default"/>
                    <property name="webBrandingId" value="josso2-default-branding"/>
                </bean>
            </list>
        </property>
    </bean>
    
    <osgi:service id="brandManagerOsgi" ref="brandManager"
                  interface="com.atricore.idbus.console.brandservice.main.spi.BrandManager"/>

    <!-- Use DB Store when available -->
    <!--bean id="brandingStore" class="com.atricore.idbus.console.brandservice.main.internal.store.MemoryBrandingStore"/-->
    <bean id="brandingStore" class="com.atricore.idbus.console.brandservice.main.internal.store.DbBrandingStore">
        <property name="brandingDefinitionDAO" ref="brandingDefinitionDAO"/>
    </bean>
    
    <!-- Installers -->
    <bean id="customBrandingInstaller" class="com.atricore.idbus.console.brandservice.main.internal.installer.CustomBrandingInstaller"/>

    <!-- Use spring bean setup, to allow multiple config sources -->
    <!--ctx:property-placeholder properties-ref="lifecycleProps" /-->
    <bean id="myBundleConfigurer"
          class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="ignoreUnresolvablePlaceholders" value="true"/>
        <property name="propertiesArray">
            <list>
                <ref bean="brandsvcProps"/>
                <ref bean="brandsvcJdoProps"/>
            </list>
        </property>
    </bean>

    <osgix:cm-properties id="brandsvcProps"
                         persistent-id="com.atricore.idbus.console.brandservice">
        <prop key="brandManager.refreshPackagesDelay">7000</prop>
        <prop key="brandManager.disableHotDeploy">false</prop>
    </osgix:cm-properties>

    <osgix:cm-properties id="brandsvcJdoProps"
                         persistent-id="com.atricore.idbus.console.db">

        <prop key="javax.jdo.option.Mapping">default</prop>
        <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>

        <prop key="jdbc.dataSourceUrl">osgi:javax.sql.DataSource/(&amp;(jdbcDS=default-ds))</prop>
 <!--   We're using a datasource now :
        <prop key="javax.jdo.option.ConnectionURL">jdbc:derby://localhost:1527/atricore-console;create=true</prop>

        <prop key="javax.jdo.option.ConnectionUserName">atricore</prop>
        <prop key="javax.jdo.option.ConnectionPassword">admin</prop>
        <prop key="javax.jdo.option.ConnectionDriverName">org.apache.derby.jdbc.ClientDriver</prop>
-->

        <prop key="datanucleus.storeManagerType">rdbms</prop>

        <prop key="datanucleus.metadata.validate">false</prop>
        <prop key="datanucleus.autoCreateSchema">true</prop>
        <prop key="datanucleus.autoCreateColumns">true</prop>
        <prop key="datanucleus.validateTables">false</prop>
        <prop key="datanucleus.validateConstraints">false</prop>

        <prop key="datanucleus.classLoaderResolverName">jdo</prop>

        <prop key="datanucleus.plugin.pluginRegistryClassName">org.atricore.idbus.bundles.datanucleus.core.OsgiPluginRegistry</prop>

        <prop key="lifecycle.validateAppliances">true</prop>
        <prop key="lifecycle.enableDebugValidation">false</prop>

        <prop key="datanucleus.metadata.autoregistration">false</prop>

    </osgix:cm-properties>


</beans>