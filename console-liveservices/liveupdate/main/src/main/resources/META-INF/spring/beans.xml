<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:osgi="http://www.springframework.org/schema/osgi"
       xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
       xmlns:ctx="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                    http://www.springframework.org/schema/beans/spring-beans.xsd
                    http://www.springframework.org/schema/osgi
                    http://www.springframework.org/schema/osgi/spring-osgi.xsd
                    http://www.springframework.org/schema/context
                    http://www.springframework.org/schema/context/spring-context.xsd
                    http://www.springframework.org/schema/osgi-compendium
                    http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

    <!-- LiveUpdate service -->
    <bean name="liveUpdateMgr" init-method="init"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.service.LiveUpdateManagerImpl">

        <property name="config" ref="liveUpdateProps"/>
        <property name="metadataRepositoryManager" ref="mdRepositoriesManager"/>
        <property name="artifactRepositoryManager" ref="artRepositoriesManager"/>
        <property name="profileManager" ref="profileManager"/>
        <property name="engine" ref="updateEngine"/>

        <property name="dataFolder" value="${karaf.data}"/>
    </bean>

    <!-- Metadta Repository Manager -->
    <bean name="mdRepositoriesManager"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.repository.impl.MetadataRepositoryManagerImpl">
        <property name="transports">
            <list>
                <ref bean="httpRepositoryTransport"/>
                <ref bean="fileRepositoryTransport"/>
            </list>
        </property>
    </bean>

    <!-- Artifact Repository Manager -->
    <bean name="artRepositoriesManager"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.repository.impl.ArtifactRepositoryManagerImpl">
        <property name="transports">
            <list>
                <ref bean="httpRepositoryTransport"/>
                <ref bean="fileRepositoryTransport"/>
            </list>
        </property>
    </bean>

    <!-- Repository Transports -->
    <bean name="httpRepositoryTransport"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.repository.impl.HttpRepositoryTransport"/>

    <bean name="fileRepositoryTransport"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.repository.impl.FileRepositoryTransport"/>

    <!-- Profile Manager -->
    <bean name="profileManager" class="com.atricore.idbus.console.liveservices.liveupdate.main.profile.impl.ProfileManagerImpl">

    </bean>

    <!-- Update Engine -->
    <bean name="updateEngine" init-method="init"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.impl.UpdateEngineImpl">
        <property name="operationsRegistry" ref="installOperationsRegistry"/>
        <property name="plans">
            <set>
                <ref bean="updatePlan"/>
            </set>
        </property>
    </bean>

    <!-- Default update plan -->
    <bean name="updatePlan" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.UpdatePlan">
        <property name="steps">
            <set>
                <bean class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.Step">
                    <property name="name" value="download-installers"/>
                </bean>
                <bean class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.Step">
                    <property name="name" value="install-installers"/>
                </bean>
                <bean class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.Step">
                    <property name="name" value="prepare-install"/>
                </bean>
                <bean class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.Step">
                    <property name="name" value="download-updates"/>
                </bean>
                <bean class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.Step">
                    <property name="name" value="install-updates"/>
                </bean>
                <bean class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.Step">
                    <property name="name" value="udpate-system"/>
                </bean>
            </set>
        </property>
    </bean>

    <bean name="installOperationsRegistry" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.impl.InstallOperationsRegistryImpl"/>

    <!-- Export LiveUpdate service using OSGi -->
    <osgi:service id="liveUpdateMgrOsgi" ref="liveUpdateMgr"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.LiveUpdateManager"/>

    <!-- Expose LiveUpdate configuration properties -->
    <osgix:cm-properties id="liveUpdateProps" persistent-id="com.atricore.idbus.console.liveservices.liveupdate">

        <prop key="repo.md.default.id">md-default</prop>
        <prop key="repo.md.default.name">LiveUpdate MD Default repository</prop>
        <prop key="repo.md.default.enabled">true</prop>
        <prop key="repo.md.default.validateSignature">true</prop>
        <prop key="repo.md.default.location">file:${karaf.data}/liveservices/liveupdate/repos/md-default/liveupdate-1.0.xml</prop>

        <prop key="repo.art.default.id">art-default</prop>
        <prop key="repo.art.default.name">LiveUpdate Artifacts Default repository</prop>
        <prop key="repo.art.default.enabled">true</prop>
        <prop key="repo.art.default.validateSignature">true</prop>
        <prop key="repo.art.default.location">file:${karaf.data}/liveservices/liveupdate/repos/art-default/</prop>

    </osgix:cm-properties>

    <ctx:property-placeholder properties-ref="liveUpdateProps"/>

</beans>