<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:osgi="http://www.springframework.org/schema/osgi"
       xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
       xmlns:ctx="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                    http://www.springframework.org/schema/beans/spring-beans.xsd
                    http://www.springframework.org/schema/osgi
                    http://www.springframework.org/schema/osgi/spring-osgi.xsd
                    http://www.springframework.org/schema/context
                    http://www.springframework.org/schema/context/spring-context.xsd
                    http://www.springframework.org/schema/osgi-compendium
                    http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

    <bean name="osgiReg" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.OsgiInstallOperationsRegistry">
        <constructor-arg ref="installOperationsRegistry"/>
    </bean>

    <osgi:list id="istallOps" interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation" cardinality="0..N">
        <osgi:listener ref="osgiReg" bind-method="register" unbind-method="unregister"/>
    </osgi:list>

    <bean name="downloadInstallersOperation" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.DownloadInstallersOperation">
        <property name="name" value="downloadInstallersOperation"/>
        <property name="stepName" value="download-installers"/>
        <property name="artMgr" ref="artRepositoriesManager"/>
    </bean>
    <osgi:service id="osgiDownloadInstallersOperation" ref="downloadInstallersOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="installInstallerOperation" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.StartInstallersOperation">
        <property name="name" value="installInstallerOperation"/>
        <property name="stepName" value="install-installers"/>
        <property name="installerRunLevel" value="${maintenanceRunLevel}"/>
    </bean>
    <osgi:service id="osgiInstallInstallerOperation" ref="installInstallerOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="downloadUpdatesOperation" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.DownloadUpdatesOperation">
        <property name="name" value="downloadUpdatesOperation"/>
        <property name="stepName" value="download-updates-start"/>
        <property name="artMgr" ref="artRepositoriesManager"/>
    </bean>
    <osgi:service id="osgiDownloadUpdatesOperation" ref="downloadUpdatesOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="installUpdatesOperation" class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.InstallUpdatesOperation">
        <property name="name" value="installUpdatesOperation"/>
        <property name="stepName" value="install-updates-start"/>
        <property name="artMgr" ref="artRepositoriesManager"/>
    </bean>
    <osgi:service id="osgiInstallUpdatesOperation" ref="installUpdatesOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="switchToMaintananceModeOperation"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.SwitchIDBusRunLevelOperation">
        <property name="name" value="switchToMaintananceMode"/>
        <property name="stepName" value="install-updates-start"/>
        <property name="runLevel" value="${maintenanceRunLevel}"/>
        <property name="configProperties" value="file:${karaf.base}/etc/config.properties"/>
    </bean>
    <osgi:service id="osgiSwitchToMaintananceModeOperation" ref="switchToMaintananceModeOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="shutdownIDBusOperation"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.ShutdownIDBusOperation">
        <property name="name" value="restartRequiredOperation"/>
        <property name="stepName" value="install-updates-end"/>
    </bean>
    <osgi:service id="osgiRestartRequiredOperation" ref="shutdownIDBusOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="waitForSystemStartupOperation"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.WaitForSystemStartup">
        <property name="name" value="waitForSystemStartupOperation"/>
        <property name="stepName" value="udpate-system-start"/>
    </bean>
    <osgi:service id="osgiWaitForSystemStartupOperation" ref="waitForSystemStartupOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

    <bean name="switchToOperationalModeOperation"
          class="com.atricore.idbus.console.liveservices.liveupdate.main.engine.operations.SwitchIDBusRunLevelOperation">
        <property name="name" value="switchToOperational"/>
        <property name="stepName" value="cleanup-end"/>
        <property name="runLevel" value="${defaultRunLevel}"/>
        <property name="configProperties" value="file:${karaf.base}/etc/config.properties"/>
    </bean>
    <osgi:service id="osgiSwitchToOperationalModeOperation" ref="switchToOperationalModeOperation"
                  interface="com.atricore.idbus.console.liveservices.liveupdate.main.engine.InstallOperation"/>

</beans>